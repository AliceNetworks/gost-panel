import{U as Ue,V as ze,W as Se,X as Ne,Y as Re,Z as Me,_ as Pe,$ as Be,a0 as De,a1 as Le}from"./index-nVRnIEpk.js";import{T as ie,E as de}from"./TableSkeleton-DMZgipLG.js";import{u as Ae,f as Ee,g as k,B as y,e as z}from"./naive-ui-Ba3Mczwr.js";import{k as $e,o as Fe,Z as E,Y as a,W as n,r,V as m,X as v,U as b,N as p,a2 as B,j as _,F as G,_ as C,c as re,m as f}from"./vue-vendor-CGi32OHI.js";import"./SwapHorizontalOutline-CC6U-UAB.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const Oe={class:"notify"},Ye=$e({__name:"Notify",setup(Ve){const i=Ae(),H=Ee(),S=r(!1),N=r(!1),$=r(!1),x=r(!1),F=r(!1),R=r([]),D=r([]),X=r([]),T=r(!1),U=r(!1),w=r(null),M=r(null),Y=[{label:"Telegram",value:"telegram"},{label:"Webhook",value:"webhook"},{label:"Email (SMTP)",value:"email"}],Z=[{label:"节点离线",value:"node_offline"},{label:"节点恢复在线",value:"node_online"},{label:"流量超限",value:"quota_exceeded"},{label:"流量预警",value:"quota_warning"},{label:"连接数告警",value:"connection_limit"},{label:"Agent 更新",value:"agent_update"}],O=()=>({name:"",type:"telegram",config:{},enabled:!0}),V=()=>({name:"",alert_type:"node_offline",channel_ids:[],condition:{},silence_duration:3e5,enabled:!0}),d=r(O()),s=r(V()),u=r({}),c=r({}),J=re({get:()=>s.value.silence_duration/6e4,set:l=>{s.value.silence_duration=l*6e4}}),ve=re(()=>R.value.filter(l=>l.enabled).map(l=>({label:`${l.name} (${K(l.type)})`,value:l.id}))),pe=r({page:1,pageSize:20}),K=l=>{const e=Y.find(h=>h.value===l);return e?e.label:l},Q=l=>{const e=Z.find(h=>h.value===l);return e?e.label:l},ee=l=>l?new Date(l).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}):"-",me=[{title:"ID",key:"id",width:60},{title:"名称",key:"name",width:150},{title:"类型",key:"type",width:120,render:l=>f(z,{type:"info",size:"small"},()=>K(l.type))},{title:"状态",key:"enabled",width:80,render:l=>f(z,{type:l.enabled?"success":"default",size:"small"},()=>l.enabled?"启用":"禁用")},{title:"最后测试",key:"last_test_at",width:150,render:l=>ee(l.last_test_at)},{title:"操作",key:"actions",width:220,render:l=>f(k,{size:"small"},()=>[f(y,{size:"small",onClick:()=>_e(l)},()=>"编辑"),f(y,{size:"small",type:"info",onClick:()=>ae(l)},()=>"测试"),f(y,{size:"small",type:"error",onClick:()=>ke(l)},()=>"删除")])}],fe=[{title:"ID",key:"id",width:60},{title:"规则名称",key:"name",width:180},{title:"告警类型",key:"alert_type",width:150,render:l=>f(z,{type:"warning",size:"small"},()=>Q(l.alert_type))},{title:"通知渠道",key:"channel_count",width:100,render:l=>`${l.channel_ids?.length||0} 个`},{title:"状态",key:"enabled",width:80,render:l=>f(z,{type:l.enabled?"success":"default",size:"small"},()=>l.enabled?"启用":"禁用")},{title:"触发次数",key:"trigger_count",width:100},{title:"操作",key:"actions",width:150,render:l=>f(k,{size:"small"},()=>[f(y,{size:"small",onClick:()=>he(l)},()=>"编辑"),f(y,{size:"small",type:"error",onClick:()=>xe(l)},()=>"删除")])}],ye=[{title:"ID",key:"id",width:60},{title:"告警类型",key:"alert_type",width:130,render:l=>f(z,{type:"warning",size:"small"},()=>Q(l.alert_type))},{title:"消息",key:"message",ellipsis:{tooltip:!0}},{title:"发送状态",key:"sent",width:100,render:l=>f(z,{type:l.sent?"success":"error",size:"small"},()=>l.sent?"已发送":"失败")},{title:"时间",key:"created_at",width:160,render:l=>ee(l.created_at)}],L=async()=>{S.value=!0;try{const l=await Ue();R.value=l||[]}catch{i.error("加载通知渠道失败")}finally{S.value=!1}},I=async()=>{N.value=!0;try{const l=await ze();D.value=l||[]}catch{i.error("加载告警规则失败")}finally{N.value=!1}},ge=async()=>{$.value=!0;try{const l=await Se({limit:100});X.value=l||[]}catch{i.error("加载告警日志失败")}finally{$.value=!1}},le=()=>{d.value=O(),u.value={},w.value=null,T.value=!0},_e=l=>{w.value=l,d.value={...O(),...l},u.value={...l.config},T.value=!0},be=()=>{u.value={},d.value.type==="telegram"?u.value={bot_token:"",chat_id:""}:d.value.type==="webhook"?u.value={url:"",method:"POST",headers:""}:d.value.type==="email"&&(u.value={smtp_host:"",smtp_port:587,username:"",password:"",from:"",to:"",use_tls:!0})},ce=async()=>{if(!d.value.name){i.error("请输入名称");return}d.value.config=u.value,x.value=!0;try{w.value?(await Ne(w.value.id,d.value),i.success("通知渠道已更新")):(await Re(d.value),i.success("通知渠道已创建")),T.value=!1,L()}catch(l){i.error(l.response?.data?.error||"保存通知渠道失败")}finally{x.value=!1}},ke=l=>{H.warning({title:"删除通知渠道",content:`确定要删除通知渠道 "${l.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await Be(l.id),i.success("通知渠道已删除"),L()}catch{i.error("删除通知渠道失败")}}})},ae=async l=>{F.value=!0;try{await De(l.id),i.success("测试通知已发送"),L()}catch(e){i.error(e.response?.data?.error||"发送测试通知失败")}finally{F.value=!1}},we=async()=>{if(!w.value){i.error("请先保存渠道后再测试");return}await ae(w.value)},te=()=>{s.value=V(),c.value={offline_duration:5},M.value=null,U.value=!0},he=l=>{M.value=l,s.value={...V(),...l},c.value={...l.condition},U.value=!0},Ce=async()=>{if(!s.value.name){i.error("请输入规则名称");return}if(!s.value.channel_ids||s.value.channel_ids.length===0){i.error("请选择至少一个通知渠道");return}s.value.condition=c.value,x.value=!0;try{M.value?(await Me(M.value.id,s.value),i.success("告警规则已更新")):(await Pe(s.value),i.success("告警规则已创建")),U.value=!1,I()}catch(l){i.error(l.response?.data?.error||"保存告警规则失败")}finally{x.value=!1}},xe=l=>{H.warning({title:"删除告警规则",content:`确定要删除告警规则 "${l.name}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await Le(l.id),i.success("告警规则已删除"),I()}catch{i.error("删除告警规则失败")}}})};return Fe(()=>{L(),I(),ge()}),(l,e)=>{const h=m("n-data-table"),j=m("n-card"),W=m("n-grid-item"),Te=m("n-grid"),g=m("n-input"),o=m("n-form-item"),A=m("n-select"),P=m("n-input-number"),q=m("n-switch"),ne=m("n-form"),ue=m("n-modal"),oe=m("n-divider"),se=m("n-text");return v(),E("div",Oe,[a(Te,{"x-gap":16,"y-gap":16,cols:1},{default:n(()=>[a(W,null,{default:n(()=>[a(j,null,{header:n(()=>[a(p(k),{justify:"space-between",align:"center"},{default:n(()=>[e[28]||(e[28]=B("span",null,"通知渠道",-1)),a(p(y),{type:"primary",onClick:le},{default:n(()=>[...e[27]||(e[27]=[_(" 添加渠道 ",-1)])]),_:1})]),_:1})]),default:n(()=>[S.value&&R.value.length===0?(v(),b(ie,{key:0,rows:2})):!S.value&&R.value.length===0?(v(),b(de,{key:1,type:"notify","action-text":"添加渠道",onAction:le})):(v(),b(h,{key:2,columns:me,data:R.value,loading:S.value,"row-key":t=>t.id},null,8,["data","loading","row-key"]))]),_:1})]),_:1}),a(W,null,{default:n(()=>[a(j,null,{header:n(()=>[a(p(k),{justify:"space-between",align:"center"},{default:n(()=>[e[30]||(e[30]=B("span",null,"告警规则",-1)),a(p(y),{type:"primary",onClick:te},{default:n(()=>[...e[29]||(e[29]=[_(" 添加规则 ",-1)])]),_:1})]),_:1})]),default:n(()=>[N.value&&D.value.length===0?(v(),b(ie,{key:0,rows:2})):!N.value&&D.value.length===0?(v(),b(de,{key:1,title:"暂无告警规则",description:"创建告警规则来监控节点状态","action-text":"添加规则",onAction:te})):(v(),b(h,{key:2,columns:fe,data:D.value,loading:N.value,"row-key":t=>t.id},null,8,["data","loading","row-key"]))]),_:1})]),_:1}),a(W,null,{default:n(()=>[a(j,{title:"告警日志"},{default:n(()=>[a(h,{columns:ye,data:X.value,loading:$.value,"row-key":t=>t.id,pagination:pe.value,size:"small","max-height":"400"},null,8,["data","loading","row-key","pagination"])]),_:1})]),_:1})]),_:1}),a(ue,{show:T.value,"onUpdate:show":e[16]||(e[16]=t=>T.value=t),preset:"dialog",title:w.value?"编辑通知渠道":"添加通知渠道",style:{width:"600px"}},{action:n(()=>[a(p(k),null,{default:n(()=>[a(p(y),{onClick:e[15]||(e[15]=t=>T.value=!1)},{default:n(()=>[...e[31]||(e[31]=[_("取消",-1)])]),_:1}),w.value?(v(),b(p(y),{key:0,type:"info",loading:F.value,onClick:we},{default:n(()=>[...e[32]||(e[32]=[_("测试",-1)])]),_:1},8,["loading"])):C("",!0),a(p(y),{type:"primary",loading:x.value,onClick:ce},{default:n(()=>[...e[33]||(e[33]=[_("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:n(()=>[a(ne,{model:d.value,"label-placement":"left","label-width":"100"},{default:n(()=>[a(o,{label:"名称"},{default:n(()=>[a(g,{value:d.value.name,"onUpdate:value":e[0]||(e[0]=t=>d.value.name=t),placeholder:"例如: Telegram Bot"},null,8,["value"])]),_:1}),a(o,{label:"类型"},{default:n(()=>[a(A,{value:d.value.type,"onUpdate:value":[e[1]||(e[1]=t=>d.value.type=t),be],options:Y},null,8,["value"])]),_:1}),d.value.type==="telegram"?(v(),E(G,{key:0},[a(o,{label:"Bot Token"},{default:n(()=>[a(g,{value:u.value.bot_token,"onUpdate:value":e[2]||(e[2]=t=>u.value.bot_token=t),placeholder:"从 @BotFather 获取"},null,8,["value"])]),_:1}),a(o,{label:"Chat ID"},{default:n(()=>[a(g,{value:u.value.chat_id,"onUpdate:value":e[3]||(e[3]=t=>u.value.chat_id=t),placeholder:"你的 Chat ID"},null,8,["value"])]),_:1})],64)):C("",!0),d.value.type==="webhook"?(v(),E(G,{key:1},[a(o,{label:"Webhook URL"},{default:n(()=>[a(g,{value:u.value.url,"onUpdate:value":e[4]||(e[4]=t=>u.value.url=t),placeholder:"https://your-webhook-url"},null,8,["value"])]),_:1}),a(o,{label:"HTTP 方法"},{default:n(()=>[a(A,{value:u.value.method,"onUpdate:value":e[5]||(e[5]=t=>u.value.method=t),options:[{label:"POST",value:"POST"},{label:"GET",value:"GET"}]},null,8,["value"])]),_:1}),a(o,{label:"Headers"},{default:n(()=>[a(g,{value:u.value.headers,"onUpdate:value":e[6]||(e[6]=t=>u.value.headers=t),type:"textarea",placeholder:'{"Content-Type": "application/json"}',autosize:{minRows:2}},null,8,["value"])]),_:1})],64)):C("",!0),d.value.type==="email"?(v(),E(G,{key:2},[a(o,{label:"SMTP 服务器"},{default:n(()=>[a(g,{value:u.value.smtp_host,"onUpdate:value":e[7]||(e[7]=t=>u.value.smtp_host=t),placeholder:"smtp.gmail.com"},null,8,["value"])]),_:1}),a(o,{label:"SMTP 端口"},{default:n(()=>[a(P,{value:u.value.smtp_port,"onUpdate:value":e[8]||(e[8]=t=>u.value.smtp_port=t),min:1,max:65535,style:{width:"150px"}},null,8,["value"])]),_:1}),a(o,{label:"用户名"},{default:n(()=>[a(g,{value:u.value.username,"onUpdate:value":e[9]||(e[9]=t=>u.value.username=t),placeholder:"your@email.com"},null,8,["value"])]),_:1}),a(o,{label:"密码"},{default:n(()=>[a(g,{value:u.value.password,"onUpdate:value":e[10]||(e[10]=t=>u.value.password=t),type:"password",placeholder:"SMTP 密码"},null,8,["value"])]),_:1}),a(o,{label:"发件人"},{default:n(()=>[a(g,{value:u.value.from,"onUpdate:value":e[11]||(e[11]=t=>u.value.from=t),placeholder:"noreply@example.com"},null,8,["value"])]),_:1}),a(o,{label:"收件人"},{default:n(()=>[a(g,{value:u.value.to,"onUpdate:value":e[12]||(e[12]=t=>u.value.to=t),placeholder:"admin@example.com (多个用逗号分隔)"},null,8,["value"])]),_:1}),a(o,{label:"使用 TLS"},{default:n(()=>[a(q,{value:u.value.use_tls,"onUpdate:value":e[13]||(e[13]=t=>u.value.use_tls=t)},null,8,["value"])]),_:1})],64)):C("",!0),a(o,{label:"启用"},{default:n(()=>[a(q,{value:d.value.enabled,"onUpdate:value":e[14]||(e[14]=t=>d.value.enabled=t)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),a(ue,{show:U.value,"onUpdate:show":e[26]||(e[26]=t=>U.value=t),preset:"dialog",title:M.value?"编辑告警规则":"添加告警规则",style:{width:"600px"}},{action:n(()=>[a(p(k),null,{default:n(()=>[a(p(y),{onClick:e[25]||(e[25]=t=>U.value=!1)},{default:n(()=>[...e[41]||(e[41]=[_("取消",-1)])]),_:1}),a(p(y),{type:"primary",loading:x.value,onClick:Ce},{default:n(()=>[...e[42]||(e[42]=[_("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:n(()=>[a(ne,{model:s.value,"label-placement":"left","label-width":"120"},{default:n(()=>[a(o,{label:"规则名称"},{default:n(()=>[a(g,{value:s.value.name,"onUpdate:value":e[17]||(e[17]=t=>s.value.name=t),placeholder:"例如: 节点离线告警"},null,8,["value"])]),_:1}),a(o,{label:"告警类型"},{default:n(()=>[a(A,{value:s.value.alert_type,"onUpdate:value":e[18]||(e[18]=t=>s.value.alert_type=t),options:Z},null,8,["value"])]),_:1}),a(o,{label:"通知渠道"},{default:n(()=>[a(A,{value:s.value.channel_ids,"onUpdate:value":e[19]||(e[19]=t=>s.value.channel_ids=t),options:ve.value,multiple:"",placeholder:"选择一个或多个渠道"},null,8,["value","options"])]),_:1}),a(oe,null,{default:n(()=>[...e[34]||(e[34]=[_("触发条件",-1)])]),_:1}),s.value.alert_type==="node_offline"?(v(),b(o,{key:0,label:"离线时长"},{default:n(()=>[a(p(k),null,{default:n(()=>[a(P,{value:c.value.offline_duration,"onUpdate:value":e[20]||(e[20]=t=>c.value.offline_duration=t),min:1,style:{width:"120px"}},null,8,["value"]),e[35]||(e[35]=B("span",null,"分钟",-1))]),_:1})]),_:1})):C("",!0),s.value.alert_type==="quota_warning"?(v(),b(o,{key:1,label:"流量使用率"},{default:n(()=>[a(p(k),null,{default:n(()=>[a(P,{value:c.value.threshold,"onUpdate:value":e[21]||(e[21]=t=>c.value.threshold=t),min:1,max:100,style:{width:"120px"}},null,8,["value"]),e[36]||(e[36]=B("span",null,"%",-1))]),_:1}),a(se,{depth:"3",style:{"margin-top":"4px","font-size":"12px"}},{default:n(()=>[...e[37]||(e[37]=[_("当流量使用达到此百分比时发送预警",-1)])]),_:1})]),_:1})):C("",!0),s.value.alert_type==="connection_limit"?(v(),b(o,{key:2,label:"连接数阈值"},{default:n(()=>[a(P,{value:c.value.max_connections,"onUpdate:value":e[22]||(e[22]=t=>c.value.max_connections=t),min:1,style:{width:"150px"}},null,8,["value"])]),_:1})):C("",!0),a(oe,null,{default:n(()=>[...e[38]||(e[38]=[_("其他选项",-1)])]),_:1}),a(o,{label:"静默时间"},{default:n(()=>[a(p(k),null,{default:n(()=>[a(P,{value:J.value,"onUpdate:value":e[23]||(e[23]=t=>J.value=t),min:1,style:{width:"120px"}},null,8,["value"]),e[39]||(e[39]=B("span",null,"分钟",-1))]),_:1}),a(se,{depth:"3",style:{"margin-top":"4px","font-size":"12px"}},{default:n(()=>[...e[40]||(e[40]=[_("同一告警在静默时间内不会重复发送",-1)])]),_:1})]),_:1}),a(o,{label:"启用"},{default:n(()=>[a(q,{value:s.value.enabled,"onUpdate:value":e[24]||(e[24]=t=>s.value.enabled=t)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"])])}}});export{Ye as default};
