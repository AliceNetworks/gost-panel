import{O as Y,P as Z,Q as q,e as G,R as H,S as J,T as ee}from"./index-nVRnIEpk.js";import{T as ae,E as le}from"./TableSkeleton-DMZgipLG.js";import{u as se}from"./useKeyboard-CbOLAjL8.js";import{u as te,f as ne,g as y,B as u,e as U,c as oe}from"./naive-ui-Ba3Mczwr.js";import{k as re,o as ie,Z as ue,Y as l,W as s,r as m,V as f,X as k,U as h,N as d,a2 as de,j as g,_ as ve,m as i}from"./vue-vendor-CGi32OHI.js";import"./SwapHorizontalOutline-CC6U-UAB.js";import"./ServerOutline-CH8la6EY.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const me={class:"users"},Pe=re({__name:"Users",setup(pe){const o=te(),D=ne(),_=m(!1),z=m(!1),x=m(!1),P=m([]),c=m(!1),b=m(!1),p=m(null),$=[{label:"管理员",value:"admin"},{label:"普通用户",value:"user"},{label:"只读用户",value:"viewer"}],M=()=>({username:"",password:"",role:"user",email:"",enabled:!0,email_verified:!0}),n=m(M()),r=m({oldPassword:"",newPassword:"",confirmPassword:""}),T=e=>e?new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"-",R=e=>({admin:"管理员",user:"普通用户",viewer:"只读用户"})[e]||e,j=[{title:"ID",key:"id",width:60},{title:"用户名",key:"username",width:120},{title:"邮箱",key:"email",ellipsis:{tooltip:!0},render:e=>e.email?i(y,{size:"small",align:"center"},()=>[e.email,e.email_verified?i(U,{type:"success",size:"tiny"},()=>"已验证"):i(U,{type:"warning",size:"tiny"},()=>"未验证")]):"-"},{title:"角色",key:"role",width:100,render:e=>i(U,{type:{admin:"error",user:"success",viewer:"info"}[e.role]||"default",size:"small"},()=>R(e.role))},{title:"状态",key:"enabled",width:80,render:e=>i(U,{type:e.enabled!==!1?"success":"default",size:"small"},()=>e.enabled!==!1?"启用":"禁用")},{title:"创建时间",key:"created_at",width:150,render:e=>T(e.created_at)},{title:"最后登录",key:"last_login_at",width:150,render:e=>e.last_login_at?i(oe,{},{trigger:()=>T(e.last_login_at),default:()=>`IP: ${e.last_login_ip||"未知"}`}):"-"},{title:"操作",key:"actions",width:200,render:e=>i(y,{size:"small"},()=>[i(u,{size:"small",onClick:()=>F(e)},()=>"编辑"),!e.email_verified&&e.email?i(u,{size:"small",type:"info",onClick:()=>L(e)},()=>"验证"):null,!e.email_verified&&e.email?i(u,{size:"small",type:"warning",onClick:()=>O(e)},()=>"重发"):null,i(u,{size:"small",type:"error",onClick:()=>I(e),disabled:e.username==="admin"},()=>"删除")])}],C=async()=>{_.value=!0;try{const e=await Y();P.value=e||[]}catch{o.error("加载用户失败")}finally{_.value=!1}},N=()=>{n.value=M(),p.value=null,c.value=!0},F=e=>{p.value=e,n.value={...M(),...e,password:"",enabled:e.enabled!==!1,email_verified:e.email_verified||!1},c.value=!0},V=async()=>{if(!n.value.username){o.error("请输入用户名");return}if(!p.value&&!n.value.password){o.error("请输入密码");return}z.value=!0;try{p.value?(await Z(p.value.id,n.value),o.success("用户已更新")):(await q(n.value),o.success("用户已创建")),c.value=!1,C()}catch(e){o.error(e.response?.data?.error||"保存用户失败")}finally{z.value=!1}},I=e=>{if(e.username==="admin"){o.error("不能删除管理员账号");return}D.warning({title:"删除用户",content:`确定要删除用户 "${e.username}" 吗？`,positiveText:"删除",negativeText:"取消",onPositiveClick:async()=>{try{await H(e.id),o.success("用户已删除"),C()}catch{o.error("删除用户失败")}}})},L=async e=>{try{await J(e.id),o.success("邮箱已验证"),C()}catch(a){o.error(a.response?.data?.error||"验证失败")}},O=async e=>{try{await ee(e.id),o.success("验证邮件已发送")}catch(a){o.error(a.response?.data?.error||"发送失败")}},A=()=>{r.value={oldPassword:"",newPassword:"",confirmPassword:""},b.value=!0},K=async()=>{if(!r.value.oldPassword||!r.value.newPassword||!r.value.confirmPassword){o.error("请填写所有字段");return}if(r.value.newPassword!==r.value.confirmPassword){o.error("两次输入的新密码不一致");return}if(r.value.newPassword.length<6){o.error("密码长度至少为 6 位");return}x.value=!0;try{await G(r.value.oldPassword,r.value.newPassword),o.success("密码已修改"),b.value=!1}catch(e){o.error(e.response?.data?.error||"修改密码失败")}finally{x.value=!1}};return ie(()=>{C()}),se({onNew:N,modalVisible:c,onSave:V}),(e,a)=>{const Q=f("n-data-table"),W=f("n-card"),w=f("n-input"),v=f("n-form-item"),X=f("n-select"),S=f("n-switch"),B=f("n-form"),E=f("n-modal");return k(),ue("div",me,[l(W,null,{header:s(()=>[l(d(y),{justify:"space-between",align:"center"},{default:s(()=>[a[15]||(a[15]=de("span",null,"用户管理",-1)),l(d(y),null,{default:s(()=>[l(d(u),{type:"primary",onClick:N},{default:s(()=>[...a[13]||(a[13]=[g(" 添加用户 ",-1)])]),_:1}),l(d(u),{onClick:A},{default:s(()=>[...a[14]||(a[14]=[g(" 修改密码 ",-1)])]),_:1})]),_:1})]),_:1})]),default:s(()=>[_.value&&P.value.length===0?(k(),h(ae,{key:0,rows:3,columns:[1,2,1,1,2]})):!_.value&&P.value.length===0?(k(),h(le,{key:1,type:"users","action-text":"添加用户",onAction:N})):(k(),h(Q,{key:2,columns:j,data:P.value,loading:_.value,"row-key":t=>t.id},null,8,["data","loading","row-key"]))]),_:1}),l(E,{show:c.value,"onUpdate:show":a[7]||(a[7]=t=>c.value=t),preset:"dialog",title:p.value?"编辑用户":"添加用户",style:{width:"500px"}},{action:s(()=>[l(d(y),null,{default:s(()=>[l(d(u),{onClick:a[6]||(a[6]=t=>c.value=!1)},{default:s(()=>[...a[16]||(a[16]=[g("取消",-1)])]),_:1}),l(d(u),{type:"primary",loading:z.value,onClick:V},{default:s(()=>[...a[17]||(a[17]=[g("保存",-1)])]),_:1},8,["loading"])]),_:1})]),default:s(()=>[l(B,{model:n.value,"label-placement":"left","label-width":"100"},{default:s(()=>[l(v,{label:"用户名"},{default:s(()=>[l(w,{value:n.value.username,"onUpdate:value":a[0]||(a[0]=t=>n.value.username=t),placeholder:"用户名",disabled:!!p.value},null,8,["value","disabled"])]),_:1}),p.value?ve("",!0):(k(),h(v,{key:0,label:"密码"},{default:s(()=>[l(w,{value:n.value.password,"onUpdate:value":a[1]||(a[1]=t=>n.value.password=t),type:"password",placeholder:"密码","show-password-on":"click"},null,8,["value"])]),_:1})),l(v,{label:"角色"},{default:s(()=>[l(X,{value:n.value.role,"onUpdate:value":a[2]||(a[2]=t=>n.value.role=t),options:$},null,8,["value"])]),_:1}),l(v,{label:"邮箱"},{default:s(()=>[l(w,{value:n.value.email,"onUpdate:value":a[3]||(a[3]=t=>n.value.email=t),placeholder:"user@example.com"},null,8,["value"])]),_:1}),l(v,{label:"启用账户"},{default:s(()=>[l(S,{value:n.value.enabled,"onUpdate:value":a[4]||(a[4]=t=>n.value.enabled=t)},null,8,["value"])]),_:1}),l(v,{label:"邮箱已验证"},{default:s(()=>[l(S,{value:n.value.email_verified,"onUpdate:value":a[5]||(a[5]=t=>n.value.email_verified=t)},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show","title"]),l(E,{show:b.value,"onUpdate:show":a[12]||(a[12]=t=>b.value=t),preset:"dialog",title:"修改密码",style:{width:"500px"}},{action:s(()=>[l(d(y),null,{default:s(()=>[l(d(u),{onClick:a[11]||(a[11]=t=>b.value=!1)},{default:s(()=>[...a[18]||(a[18]=[g("取消",-1)])]),_:1}),l(d(u),{type:"primary",loading:x.value,onClick:K},{default:s(()=>[...a[19]||(a[19]=[g("确认",-1)])]),_:1},8,["loading"])]),_:1})]),default:s(()=>[l(B,{model:r.value,"label-placement":"left","label-width":"100"},{default:s(()=>[l(v,{label:"旧密码"},{default:s(()=>[l(w,{value:r.value.oldPassword,"onUpdate:value":a[8]||(a[8]=t=>r.value.oldPassword=t),type:"password",placeholder:"输入旧密码","show-password-on":"click"},null,8,["value"])]),_:1}),l(v,{label:"新密码"},{default:s(()=>[l(w,{value:r.value.newPassword,"onUpdate:value":a[9]||(a[9]=t=>r.value.newPassword=t),type:"password",placeholder:"输入新密码","show-password-on":"click"},null,8,["value"])]),_:1}),l(v,{label:"确认密码"},{default:s(()=>[l(w,{value:r.value.confirmPassword,"onUpdate:value":a[10]||(a[10]=t=>r.value.confirmPassword=t),type:"password",placeholder:"再次输入新密码","show-password-on":"click"},null,8,["value"])]),_:1})]),_:1},8,["model"])]),_:1},8,["show"])])}}});export{Pe as default};
