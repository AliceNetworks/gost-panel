import{i as X}from"./echarts-HRpVOA9p.js";import{h as xe,i as ke,j as Se}from"./index-nVRnIEpk.js";import{k as ie,X as z,Z as re,a2 as r,r as i,o as Ne,n as Ce,E as Oe,Y as e,W as t,V as p,N as d,j as S,a4 as M,U as Y,_ as Be,m as Te}from"./vue-vendor-CGi32OHI.js";import{a as le,b as Le,c as Pe,e as Z}from"./naive-ui-Ba3Mczwr.js";import{N as ne,S as Me,D as ze}from"./ServerOutline-CH8la6EY.js";import{R as Ie}from"./RefreshOutline-BlwU_6pp.js";import{_ as Re}from"./_plugin-vue_export-helper-DlAUqK2U.js";const De={xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink",viewBox:"0 0 512 512"},se=ie({name:"CheckmarkCircleOutline",render:function(N,B){return z(),re("svg",De,B[0]||(B[0]=[r("path",{d:"M448 256c0-106-86-192-192-192S64 150 64 256s86 192 192 192s192-86 192-192z",fill:"none",stroke:"currentColor","stroke-miterlimit":"10","stroke-width":"32"},null,-1),r("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"32",d:"M352 176L217.6 336L160 272"},null,-1)]))}}),O=i("default"),$=new Set,We=300*1e3,$e=()=>document.querySelector('link[rel="icon"]')?.href||"/vite.svg";function Ae(){const I=async()=>{if(!("Notification"in window))return!1;if(Notification.permission==="granted")return O.value="granted",!0;if(Notification.permission!=="denied"){const n=await Notification.requestPermission();return O.value=n,n==="granted"}return!1},N=(n,_)=>{if(O.value!=="granted")return null;const C=$e(),m=new Notification(n,{icon:C,badge:C,..._});return m.onclick=()=>{window.focus(),m.close()},m};return{notificationPermission:O,requestPermission:I,showNotification:N,notifyNodeOffline:(n,_)=>{$.has(n)||($.add(n),N("节点离线告警",{body:`节点 "${_}" 已离线`,tag:`node-offline-${n}`,requireInteraction:!0}),setTimeout(()=>{$.delete(n)},We))},notifyNodeOnline:(n,_)=>{$.delete(n),N("节点恢复上线",{body:`节点 "${_}" 已恢复上线`,tag:`node-online-${n}`})},checkPermission:()=>("Notification"in window&&(O.value=Notification.permission),O.value)}}const Ue={class:"dashboard"},Ee={class:"stat-row"},Fe={class:"value"},qe={class:"stat-row"},Ve={class:"value"},je={class:"stat-row"},He={class:"value highlight"},Ge=ie({__name:"Dashboard",setup(I){const{requestPermission:N,notifyNodeOffline:B,notifyNodeOnline:Q,checkPermission:ee}=Ae(),n=i(!1),_=i(!1),C=i(!1),m=i(!0),A=i(1e4),T=i(null),U=i(1),E=i(null),F=i(null),q=i(null),V=i(!1);let R=null,b=null,w=null,x=null,g=null;const ce=[{label:"5s",value:5e3},{label:"10s",value:1e4},{label:"30s",value:3e4},{label:"60s",value:6e4}],ue=[{label:"1 小时",value:1},{label:"6 小时",value:6},{label:"12 小时",value:12},{label:"24 小时",value:24}],c=i({total_nodes:0,online_nodes:0,total_clients:0,online_clients:0,total_traffic_in:0,total_traffic_out:0,total_connections:0}),k=i([]),L=i([]),de=[{title:"名称",key:"name",width:120},{title:"地址",key:"host",ellipsis:{tooltip:!0}},{title:"状态",key:"status",width:100,render:a=>Te(Z,{type:a.status==="online"?"success":"default",size:"small"},()=>a.status==="online"?"在线":"离线")},{title:"连接数",key:"connections",width:100},{title:"入站流量",key:"traffic_in",width:120,render:a=>D(a.traffic_in)},{title:"出站流量",key:"traffic_out",width:120,render:a=>D(a.traffic_out)}],D=a=>{if(a===0)return"0 B";const o=1024,s=["B","KB","MB","GB","TB"],l=Math.floor(Math.log(a)/Math.log(o));return parseFloat((a/Math.pow(o,l)).toFixed(2))+" "+s[l]},fe=a=>a.toLocaleTimeString(),ve=async()=>{_.value=!0;try{const a=await xe();c.value=a,T.value=new Date,j()}catch(a){console.error("Failed to load stats",a)}finally{_.value=!1}},pe=async()=>{C.value=!0;try{const a=await ke();k.value=a}catch(a){console.error("Failed to load nodes",a)}finally{C.value=!1}},te=async()=>{try{const a=await Se(U.value);L.value=a||[],oe()}catch(a){console.error("Failed to load traffic history",a)}},_e=()=>{E.value&&(b=X(E.value),oe(),window.addEventListener("resize",()=>{b?.resize(),w?.resize(),x?.resize()}))},me=()=>{F.value&&(w=X(F.value)),q.value&&(x=X(q.value)),j()},j=()=>{const a=c.value.online_nodes,o=c.value.total_nodes-a,s=c.value.online_clients,l=c.value.total_clients-s,v=(u,P,f)=>({backgroundColor:"transparent",tooltip:{trigger:"item",backgroundColor:"rgba(15, 21, 53, 0.95)",borderColor:"rgba(255, 255, 255, 0.1)",textStyle:{color:"#ffffff"},formatter:"{b}: {c} ({d}%)"},legend:{orient:"vertical",right:"5%",top:"center",textStyle:{color:"rgba(255, 255, 255, 0.7)"}},series:[{name:f,type:"pie",radius:["45%","70%"],center:["35%","50%"],avoidLabelOverlap:!1,itemStyle:{borderRadius:6,borderColor:"rgba(0, 0, 0, 0.3)",borderWidth:2},label:{show:!0,position:"center",formatter:()=>`${u}/${u+P}`,fontSize:18,fontWeight:"bold",color:"#fff"},emphasis:{label:{show:!0,fontSize:20,fontWeight:"bold"}},data:[{value:u,name:"在线",itemStyle:{color:"#22c55e"}},{value:P,name:"离线",itemStyle:{color:"#6b7280"}}]}]});w&&w.setOption(v(a,o,"节点状态")),x&&x.setOption(v(s,l,"客户端状态"))},oe=()=>{if(!b)return;const a=L.value.map(u=>new Date(u.time).toLocaleTimeString()),o=L.value.map(u=>u.traffic_in/(1024*1024)),s=L.value.map(u=>u.traffic_out/(1024*1024)),l=L.value.map(u=>u.connections),v={backgroundColor:"transparent",tooltip:{trigger:"axis",backgroundColor:"rgba(15, 21, 53, 0.95)",borderColor:"rgba(255, 255, 255, 0.1)",borderWidth:1,textStyle:{color:"#ffffff"},axisPointer:{type:"cross",lineStyle:{color:"rgba(255, 255, 255, 0.2)"}}},legend:{data:["入站流量 (MB)","出站流量 (MB)","连接数"],textStyle:{color:"rgba(255, 255, 255, 0.7)"},top:0},grid:{left:"3%",right:"4%",bottom:"3%",top:"40px",containLabel:!0},xAxis:{type:"category",boundaryGap:!1,data:a,axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"rgba(255, 255, 255, 0.5)"}},yAxis:[{type:"value",name:"流量 (MB)",position:"left",nameTextStyle:{color:"rgba(255, 255, 255, 0.5)"},axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"rgba(255, 255, 255, 0.5)"},splitLine:{lineStyle:{color:"rgba(255, 255, 255, 0.05)"}}},{type:"value",name:"连接数",position:"right",nameTextStyle:{color:"rgba(255, 255, 255, 0.5)"},axisLine:{lineStyle:{color:"rgba(255, 255, 255, 0.1)"}},axisLabel:{color:"rgba(255, 255, 255, 0.5)"},splitLine:{show:!1}}],series:[{name:"入站流量 (MB)",type:"line",smooth:!0,data:o,itemStyle:{color:"#22c55e"},lineStyle:{width:2,shadowColor:"rgba(34, 197, 94, 0.3)",shadowBlur:10},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(34, 197, 94, 0.3)"},{offset:1,color:"rgba(34, 197, 94, 0.02)"}]}}},{name:"出站流量 (MB)",type:"line",smooth:!0,data:s,itemStyle:{color:"#3b82f6"},lineStyle:{width:2,shadowColor:"rgba(59, 130, 246, 0.3)",shadowBlur:10},areaStyle:{color:{type:"linear",x:0,y:0,x2:0,y2:1,colorStops:[{offset:0,color:"rgba(59, 130, 246, 0.3)"},{offset:1,color:"rgba(59, 130, 246, 0.02)"}]}}},{name:"连接数",type:"line",smooth:!0,yAxisIndex:1,data:l,itemStyle:{color:"#f59e0b"},lineStyle:{width:2,shadowColor:"rgba(245, 158, 11, 0.3)",shadowBlur:10}}]};b.setOption(v)},H=async()=>{await Promise.all([ve(),pe(),te()])},G=()=>{J(),m.value&&(R=setInterval(H,A.value))},J=()=>{R&&(clearInterval(R),R=null)},ge=a=>{a?G():J()},ye=()=>{m.value&&G()},he=async a=>{a?await N()?localStorage.setItem("notificationsEnabled","true"):n.value=!1:localStorage.setItem("notificationsEnabled","false")},ae=()=>{const o=`${window.location.protocol==="https:"?"wss:":"ws:"}//${window.location.host}/ws`;g=new WebSocket(o),g.onopen=()=>{V.value=!0},g.onmessage=s=>{try{const l=JSON.parse(s.data);be(l)}catch{}},g.onclose=()=>{V.value=!1,setTimeout(ae,5e3)},g.onerror=()=>{g?.close()}},be=a=>{switch(a.type){case"node_status":const o=a.data,s=k.value.findIndex(l=>l.id===o.node_id);if(s!==-1){const l=k.value[s].status,v=k.value[s].name;k.value[s]={...k.value[s],status:o.status,connections:o.connections,traffic_in:o.traffic_in,traffic_out:o.traffic_out},n.value&&l!==o.status&&(o.status==="offline"?B(o.node_id,v):o.status==="online"&&l==="offline"&&Q(o.node_id,v))}T.value=new Date;break;case"stats":c.value=a.data,T.value=new Date,j();break}};return Ne(async()=>{await H(),await Ce(),_e(),me(),G(),ae(),localStorage.getItem("notificationsEnabled")==="true"&&ee()==="granted"&&(n.value=!0)}),Oe(()=>{J(),b&&(b.dispose(),b=null),w&&(w.dispose(),w=null),x&&(x.dispose(),x=null),g&&(g.close(),g=null)}),(a,o)=>{const s=p("n-select"),l=p("n-icon"),v=p("n-space"),u=p("n-text"),P=p("n-button"),f=p("n-card"),W=p("n-statistic"),y=p("n-grid-item"),K=p("n-grid"),we=p("n-data-table");return z(),re("div",Ue,[e(f,{class:"mb-4"},{default:t(()=>[e(v,{justify:"space-between",align:"center"},{default:t(()=>[e(v,{align:"center"},{default:t(()=>[e(d(le),{value:m.value,"onUpdate:value":[o[0]||(o[0]=h=>m.value=h),ge]},{checked:t(()=>[...o[4]||(o[4]=[S("自动刷新",-1)])]),unchecked:t(()=>[...o[5]||(o[5]=[S("自动刷新",-1)])]),_:1},8,["value"]),e(s,{value:A.value,"onUpdate:value":[o[1]||(o[1]=h=>A.value=h),ye],options:ce,disabled:!m.value,style:{width:"120px"}},null,8,["value","disabled"]),e(d(Le),{vertical:""}),e(d(Pe),{trigger:"hover"},{trigger:t(()=>[e(d(le),{value:n.value,"onUpdate:value":[o[2]||(o[2]=h=>n.value=h),he]},{checked:t(()=>[e(l,null,{default:t(()=>[e(d(ne))]),_:1})]),unchecked:t(()=>[e(l,null,{default:t(()=>[e(d(ne))]),_:1})]),_:1},8,["value"])]),default:t(()=>[S(" "+M(n.value?"浏览器通知已开启":"点击开启浏览器通知"),1)]),_:1})]),_:1}),e(v,{align:"center"},{default:t(()=>[V.value?(z(),Y(d(Z),{key:0,type:"success",size:"small"},{default:t(()=>[...o[6]||(o[6]=[S(" 实时 ",-1)])]),_:1})):(z(),Y(d(Z),{key:1,type:"default",size:"small"},{default:t(()=>[...o[7]||(o[7]=[S(" 离线 ",-1)])]),_:1})),T.value?(z(),Y(u,{key:2,depth:"3"},{default:t(()=>[S(" 更新时间: "+M(fe(T.value)),1)]),_:1})):Be("",!0),e(P,{loading:_.value,onClick:H},{icon:t(()=>[e(l,null,{default:t(()=>[e(d(Ie))]),_:1})]),default:t(()=>[o[8]||(o[8]=S(" 刷新 ",-1))]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1}),e(K,{"x-gap":16,"y-gap":16,cols:4},{default:t(()=>[e(y,null,{default:t(()=>[e(f,null,{default:t(()=>[e(W,{label:"节点总数",value:c.value.total_nodes},{prefix:t(()=>[e(l,null,{default:t(()=>[e(d(Me))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(y,null,{default:t(()=>[e(f,null,{default:t(()=>[e(W,{label:"在线节点",value:c.value.online_nodes},{prefix:t(()=>[e(l,{color:"#18a058"},{default:t(()=>[e(d(se))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(y,null,{default:t(()=>[e(f,null,{default:t(()=>[e(W,{label:"客户端总数",value:c.value.total_clients},{prefix:t(()=>[e(l,null,{default:t(()=>[e(d(ze))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1}),e(y,null,{default:t(()=>[e(f,null,{default:t(()=>[e(W,{label:"在线客户端",value:c.value.online_clients},{prefix:t(()=>[e(l,{color:"#18a058"},{default:t(()=>[e(d(se))]),_:1})]),_:1},8,["value"])]),_:1})]),_:1})]),_:1}),e(K,{"x-gap":16,"y-gap":16,cols:2,class:"mt-4"},{default:t(()=>[e(y,null,{default:t(()=>[e(f,{title:"节点状态分布"},{default:t(()=>[r("div",{ref_key:"nodePieRef",ref:F,style:{height:"200px"}},null,512)]),_:1})]),_:1}),e(y,null,{default:t(()=>[e(f,{title:"客户端状态分布"},{default:t(()=>[r("div",{ref_key:"clientPieRef",ref:q,style:{height:"200px"}},null,512)]),_:1})]),_:1})]),_:1}),e(f,{title:"流量趋势",class:"mt-4"},{"header-extra":t(()=>[e(s,{value:U.value,"onUpdate:value":[o[3]||(o[3]=h=>U.value=h),te],options:ue,style:{width:"100px"},size:"small"},null,8,["value"])]),default:t(()=>[r("div",{ref_key:"chartRef",ref:E,style:{height:"300px"}},null,512)]),_:1}),e(f,{title:"流量统计",class:"mt-4"},{default:t(()=>[e(K,{"x-gap":24,cols:3},{default:t(()=>[e(y,null,{default:t(()=>[r("div",Ee,[o[9]||(o[9]=r("span",{class:"label"},"入站流量",-1)),r("span",Fe,M(D(c.value.total_traffic_in)),1)])]),_:1}),e(y,null,{default:t(()=>[r("div",qe,[o[10]||(o[10]=r("span",{class:"label"},"出站流量",-1)),r("span",Ve,M(D(c.value.total_traffic_out)),1)])]),_:1}),e(y,null,{default:t(()=>[r("div",je,[o[11]||(o[11]=r("span",{class:"label"},"当前连接",-1)),r("span",He,M(c.value.total_connections),1)])]),_:1})]),_:1})]),_:1}),e(f,{title:"节点状态",class:"mt-4"},{default:t(()=>[e(we,{columns:de,data:k.value,loading:C.value,"row-key":h=>h.id,size:"small","max-height":300},null,8,["data","loading","row-key"])]),_:1})])}}}),tt=Re(Ge,[["__scopeId","data-v-d4a4a203"]]);export{tt as default};
